import { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";

const workoutDays = Array.from({ length: 10 }, (_, i) => ({
  day: i + 1,
  sections: [
    { title: "Pushup Circuit (3 Rounds)", exercises: [
      { text: "Diamond Pushups – 10–15 reps" },
      { text: "Explosive Pushups – 8–10 reps" },
      { text: "Slow Negative Pushups – 5 reps (5–8 sec down)", time: 60 },
      { text: "Wide Pushups – 12 reps" },
    ], rest: 60, rounds: 3 },
    { title: "Arms Finisher (2–3 Rounds)", exercises: [
      { text: "Triceps Dips (Chair or Bench) – 12–15 reps" },
      { text: "Close-Grip Pushups – 10–12 reps" },
      { text: "Isometric Bicep Hold (Towel/Band) – 30 sec", time: 30 },
    ], rest: 45, rounds: 2 },
    { title: "Abs & Obliques Circuit (3 Rounds)", exercises: [
      { text: "Bicycle Crunches – 20 reps" },
      { text: "Russian Twists – 20 reps (10 each side)" },
      { text: "Leg Raises / Reverse Crunches – 15 reps" },
      { text: "Side Plank with Hip Dips – 30 sec each side", time: 60 },
      { text: "V-Ups – 12–15 reps" },
    ], rest: 60, rounds: 3 },
  ]
}));

export default function WorkoutApp() {
  const [selectedDay, setSelectedDay] = useState(null);
  const [currentSection, setCurrentSection] = useState(0);
  const [currentExercise, setCurrentExercise] = useState(0);
  const [currentRound, setCurrentRound] = useState(1);
  const [timeLeft, setTimeLeft] = useState(0);
  const [isRunning, setIsRunning] = useState(false);
  const [startTime, setStartTime] = useState(null);
  const [elapsedTime, setElapsedTime] = useState(0);
  const [completedDays, setCompletedDays] = useState([]);

  const currentDay = selectedDay != null ? workoutDays[selectedDay] : null;
  const section = currentDay?.sections[currentSection];
  const exercise = section?.exercises[currentExercise];
  const totalWorkoutSteps = currentDay?.sections.reduce((total, sec) => total + (sec.exercises.length * sec.rounds), 0);
  const stepsDone = currentDay?.sections.slice(0, currentSection).reduce((total, sec) => total + sec.exercises.length * sec.rounds, 0) + ((currentRound - 1) * section?.exercises.length + currentExercise);
  const currentProgress = Math.floor((stepsDone / totalWorkoutSteps) * 100);

  useEffect(() => {
    let timer;
    if (isRunning && timeLeft > 0) {
      timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
    }
    return () => clearTimeout(timer);
  }, [isRunning, timeLeft]);

  useEffect(() => {
    if (exercise?.time) {
      setTimeLeft(exercise.time);
    } else {
      setTimeLeft(0);
    }
  }, [currentExercise, currentSection, currentRound]);

  const startWorkout = () => {
    setIsRunning(true);
    setStartTime(Date.now());
  };

  const stopWorkout = () => {
    setIsRunning(false);
    setElapsedTime(Math.floor((Date.now() - startTime) / 1000));
  };

  const nextExercise = () => {
    if (currentExercise < section.exercises.length - 1) {
      setCurrentExercise(currentExercise + 1);
    } else if (currentRound < section.rounds) {
      setCurrentRound(currentRound + 1);
      setCurrentExercise(0);
    } else if (currentSection < currentDay.sections.length - 1) {
      setCurrentSection(currentSection + 1);
      setCurrentExercise(0);
      setCurrentRound(1);
    } else {
      const updated = [...completedDays, selectedDay];
      setCompletedDays(updated);
      stopWorkout();
    }
  };

  const prevExercise = () => {
    if (currentExercise > 0) {
      setCurrentExercise(currentExercise - 1);
    } else if (currentRound > 1) {
      setCurrentRound(currentRound - 1);
      setCurrentExercise(section.exercises.length - 1);
    } else if (currentSection > 0) {
      const prevSection = currentDay.sections[currentSection - 1];
      setCurrentSection(currentSection - 1);
      setCurrentExercise(prevSection.exercises.length - 1);
      setCurrentRound(prevSection.rounds);
    }
  };

  const isLastStep = currentSection === currentDay?.sections.length - 1 &&
                     currentExercise === section?.exercises.length - 1 &&
                     currentRound === section?.rounds;

  if (selectedDay == null) {
    return (
      <div className="max-w-xl mx-auto p-4">
        <h1 className="text-2xl font-bold mb-4 text-center">10-Day Beach Body Workout</h1>
        <div className="grid grid-cols-2 gap-4">
          {workoutDays.map((day, idx) => (
            <Button
              key={idx}
              className="w-full"
              onClick={() => {
                setSelectedDay(idx);
                setCurrentSection(0);
                setCurrentExercise(0);
                setCurrentRound(1);
                setElapsedTime(0);
                setIsRunning(false);
              }}
            >
              Day {day.day} {completedDays.includes(idx) ? "✅" : ""}
            </Button>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="max-w-xl mx-auto p-4">
      <h1 className="text-2xl font-bold mb-4 text-center">Day {selectedDay + 1} Workout</h1>

      <div className="mb-4">
        <p className="text-sm text-center mb-1">Workout Progress</p>
        <div className="w-full bg-gray-200 rounded-full h-2.5">
          <div className="bg-green-500 h-2.5 rounded-full" style={{ width: `${currentProgress}%` }}></div>
        </div>
      </div>

      <div className="mb-6">
        <h2 className="text-xl font-semibold mb-2">{section.title} (Round {currentRound}/{section.rounds})</h2>
        <p className="text-lg mb-2">Current: {exercise.text}</p>
        {exercise.time && <p className="text-sm">Time left: {timeLeft}s</p>}
      </div>

      <div className="flex gap-2 mb-4">
        <Button onClick={startWorkout} disabled={isRunning}>Start</Button>
        <Button onClick={stopWorkout} disabled={!isRunning}>Stop</Button>
        <Button onClick={prevExercise} disabled={currentSection === 0 && currentRound === 1 && currentExercise === 0}>Previous</Button>
        <Button onClick={nextExercise}>{isLastStep ? "Finish" : "Next"}</Button>
      </div>

      <div className="text-center text-sm text-gray-500">
        Elapsed Time: {elapsedTime}s
      </div>

      <div className="mt-6 text-center">
        <Button variant="outline" onClick={() => setSelectedDay(null)}>
          Back to Days
        </Button>
      </div>
    </div>
  );
}
